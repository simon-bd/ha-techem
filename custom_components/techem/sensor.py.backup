"""Sensor platform for Techem integration."""
from __future__ import annotations
from datetime import timedelta
import logging
from homeassistant.components.sensor import SensorEntity, SensorStateClass
from homeassistant.config_entries import ConfigEntry
from homeassistant.const import CONF_EMAIL, CONF_PASSWORD, UnitOfEnergy, UnitOfVolume
from homeassistant.core import HomeAssistant
from homeassistant.helpers.entity_platform import AddEntitiesCallback
from homeassistant.helpers.update_coordinator import DataUpdateCoordinator, CoordinatorEntity
from .const import DOMAIN, CONF_COUNTRY, CONF_OBJECT_ID
from .techem_api import TechemAPI

_LOGGER = logging.getLogger(__name__)
SCAN_INTERVAL = timedelta(hours=1)

async def async_setup_entry(
    hass: HomeAssistant,
    entry: ConfigEntry,
    async_add_entities: AddEntitiesCallback,
) -> None:
    """Set up Techem sensors."""
    api = TechemAPI(
        entry.data[CONF_EMAIL],
        entry.data[CONF_PASSWORD],
        entry.data[CONF_OBJECT_ID],
        entry.data[CONF_COUNTRY]
    )

    # Create coordinators for yearly and weekly data
    yearly_coordinator = DataUpdateCoordinator(
        hass,
        _LOGGER,
        name="techem_yearly",
        update_method=lambda: hass.async_add_executor_job(api.get_data, True),
        update_interval=SCAN_INTERVAL,
    )

    weekly_coordinator = DataUpdateCoordinator(
        hass,
        _LOGGER,
        name="techem_weekly",
        update_method=lambda: hass.async_add_executor_job(api.get_data, False),
        update_interval=SCAN_INTERVAL,
    )

    # Fetch initial data
    await yearly_coordinator.async_config_entry_first_refresh()
    await weekly_coordinator.async_config_entry_first_refresh()

    sensors = [
        TechemSensor(yearly_coordinator, "energy", "Energy Year", UnitOfEnergy.KILO_WATT_HOUR, 0),
        TechemSensor(yearly_coordinator, "water", "Water Year", UnitOfVolume.CUBIC_METERS, 1),
        TechemSensor(weekly_coordinator, "energy", "Energy Week", UnitOfEnergy.KILO_WATT_HOUR, 0),
        TechemSensor(weekly_coordinator, "water", "Water Week", UnitOfVolume.CUBIC_METERS, 1),
    ]

    async_add_entities(sensors)

class TechemSensor(CoordinatorEntity, SensorEntity):
    """Techem sensor."""

    def __init__(self, coordinator, sensor_type: str, name: str, unit: str, index: int):
        """Initialize the sensor."""
        super().__init__(coordinator)
        self._sensor_type = sensor_type
        self._index = index
        self._attr_name = f"Techem {name}"
        self._attr_unique_id = f"techem_{coordinator.config_entry.unique_id}_{sensor_type}_{coordinator.name.split('_')[1]}"
        self._attr_native_unit_of_measurement = unit
        self._attr_state_class = SensorStateClass.TOTAL_INCREASING

    @property
    def native_value(self):
        """Return the state of the sensor."""
        if self.coordinator.data and "values" in self.coordinator.data:
            raw_value = self.coordinator.data["values"][self._index]
            if self._sensor_type == "water":
                return round(raw_value, 3)
            return round(raw_value, 1)
        return None

    @property
    def extra_state_attributes(self):
        """Return extra attributes."""
        if self.coordinator.data and "comparisonValues" in self.coordinator.data:
            comp_value = self.coordinator.data["comparisonValues"][self._index]
            if self._sensor_type == "water":
                comp = round(comp_value, 3)
            else:
                comp = round(comp_value, 1)
            return {"comparison": comp}
        return {}